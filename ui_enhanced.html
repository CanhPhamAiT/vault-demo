<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vault Enterprise Manager</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header {
            background: white; padding: 30px; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 30px;
        }
        .header h1 { color: #333; font-size: 2.5em; margin-bottom: 10px; }
        .header .subtitle { color: #666; font-size: 1.1em; }
        
        .login-box {
            background: white; padding: 40px; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); max-width: 500px; margin: 0 auto;
        }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; color: #555; margin-bottom: 8px; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;
            font-size: 1em; transition: border-color 0.3s;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; border-color: #667eea;
        }
        .btn {
            padding: 14px 28px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 8px; font-size: 1.1em;
            cursor: pointer; transition: transform 0.2s;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn-secondary { background: #6c757d; }
        .btn-danger { background: #dc3545; }
        .btn-success { background: #28a745; }
        .btn-small { padding: 8px 16px; font-size: 0.9em; }
        
        .error { background: #f8d7da; color: #721c24; padding: 12px; border-radius: 8px; margin-bottom: 20px; }
        .success { background: #d4edda; color: #155724; padding: 12px; border-radius: 8px; margin-bottom: 20px; }
        .warning { background: #fff3cd; color: #856404; padding: 12px; border-radius: 8px; margin-bottom: 20px; }
        
        .tabs {
            display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;
        }
        .tab {
            padding: 12px 24px; background: white; border: none; border-radius: 8px;
            cursor: pointer; font-size: 1em; transition: all 0.3s;
        }
        .tab:hover { background: #f0f0f0; }
        .tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        
        .user-bar {
            background: white; padding: 15px 20px; border-radius: 10px;
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; flex-wrap: wrap; gap: 15px;
        }
        .user-info { display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
        .user-badge { background: #e3f2fd; padding: 8px 16px; border-radius: 6px; }
        .user-badge strong { color: #1976d2; }
        
        .secrets-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px; margin-top: 20px;
        }
        .secret-card {
            background: white; padding: 25px; border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: transform 0.3s;
        }
        .secret-card:hover { transform: translateY(-5px); }
        .secret-card h3 {
            color: #333; margin-bottom: 15px; padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0; display: flex;
            justify-content: space-between; align-items: center;
        }
        .secret-card .mount-label {
            font-size: 0.7em; background: #667eea; color: white;
            padding: 4px 8px; border-radius: 4px;
        }
        
        .secret-item { margin-bottom: 12px; padding: 10px; background: #f8f9fa; border-radius: 6px; }
        .secret-item label { font-weight: 600; color: #555; display: block; margin-bottom: 5px; }
        .secret-value { display: flex; gap: 10px; align-items: center; }
        .secret-value input {
            flex: 1; padding: 8px; border: 1px solid #e0e0e0;
            border-radius: 4px; font-family: monospace; font-size: 0.9em;
        }
        .copy-btn {
            padding: 8px 16px; background: #667eea; color: white;
            border: none; border-radius: 4px; cursor: pointer;
            transition: background 0.3s;
        }
        .copy-btn:hover { background: #5568d3; }
        .copy-btn.copied { background: #28a745; }
        
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        .stat-card {
            background: white; padding: 25px; border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-card .stat-value {
            font-size: 3em; font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .stat-card .stat-label { color: #666; font-size: 1.1em; margin-top: 10px; }
        
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: white; padding: 30px; border-radius: 15px;
            max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0;
        }
        .modal-header h2 { color: #333; }
        .close-btn {
            background: none; border: none; font-size: 2em;
            cursor: pointer; color: #999;
        }
        
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .mt-20 { margin-top: 20px; }
        .mb-20 { margin-bottom: 20px; }
        .loading {
            text-align: center; padding: 40px; color: white;
            font-size: 1.2em;
        }
        .demo-users {
            background: #fff3cd; padding: 15px; border-radius: 8px;
            margin-top: 20px; font-size: 0.9em;
        }
        .demo-users h4 { margin-bottom: 10px; color: #856404; }
        .demo-users ul { list-style: none; padding-left: 0; }
        .demo-users li {
            margin: 5px 0; padding: 8px; background: white;
            border-radius: 4px; border-left: 4px solid #ffc107;
        }
        
        .action-buttons {
            display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;
        }
        .delete-btn { background: #dc3545 !important; }
        .delete-btn:hover { background: #c82333 !important; }
        
        .cert-display {
            background: #f8f9fa; padding: 15px; border-radius: 8px;
            font-family: monospace; font-size: 0.85em;
            white-space: pre-wrap; word-break: break-all;
            max-height: 300px; overflow-y: auto;
            border: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê Vault Enterprise Manager</h1>
            <p class="subtitle">
                H·ªá th·ªëng qu·∫£n l√Ω m·∫≠t kh·∫©u t·∫≠p trung ‚Ä¢ Ph√¢n quy·ªÅn ‚Ä¢ Audit Log ‚Ä¢ Backup & Recovery ‚Ä¢ PEM Files
            </p>
        </div>

        <div id="login-section" class="login-box">
            <h2 style="margin-bottom: 20px;">ƒêƒÉng nh·∫≠p</h2>
            <div id="message"></div>
            <form id="login-form">
                <div class="form-group">
                    <label>Username:</label>
                    <input type="text" id="username" placeholder="Nh·∫≠p username" required autofocus>
                </div>
                <div class="form-group">
                    <label>Password:</label>
                    <input type="password" id="password" placeholder="Nh·∫≠p password" required>
                </div>
                <button type="submit" class="btn" style="width: 100%;">ƒêƒÉng nh·∫≠p</button>
            </form>
            
            <div class="demo-users">
                <h4>üë• Demo Users:</h4>
                <ul>
                    <li><strong>admin</strong> / admin123 - Full quy·ªÅn, xem audit log</li>
                    <li><strong>lead1</strong> / lead123 - Team lead, qu·∫£n l√Ω team secrets</li>
                    <li><strong>dev1, dev2</strong> / dev123 - Developers, dev secrets only</li>
                    <li><strong>ops1, ops2</strong> / ops123 - Operations, ops secrets only</li>
                    <li><strong>guest</strong> / guest123 - Read-only all secrets</li>
                </ul>
            </div>
        </div>

        <div id="dashboard-section" class="hidden">
            <div class="user-bar">
                <div class="user-info">
                    <div class="user-badge">
                        <strong>üë§ User:</strong> <span id="current-user"></span>
                    </div>
                    <div class="user-badge">
                        <strong>üéØ Policies:</strong> <span id="current-policies"></span>
                    </div>
                    <div class="user-badge">
                        <strong>‚è±Ô∏è Session:</strong> <span id="session-time"></span>
                    </div>
                </div>
                <button class="btn btn-danger btn-small" onclick="logout()">ƒêƒÉng xu·∫•t</button>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="showTab('secrets')">üì¶ Secrets</button>
                <button class="tab" onclick="showTab('team')">ü§ù Team Secrets</button>
                <button class="tab" onclick="showTab('pem')">üîí PEM Files</button>
                <button class="tab" onclick="showTab('pki')">üîê Certificates (PKI)</button>
                <button class="tab" onclick="showTab('stats')">üìä Statistics</button>
                <button class="tab" onclick="showTab('audit')">üìù Audit Log</button>
            </div>

            <div id="content-area"></div>
        </div>

        <!-- Modals -->
        <div id="create-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>T·∫°o Secret M·ªõi</h2>
                    <button class="close-btn" onclick="closeModal('create-modal')">&times;</button>
                </div>
                <form id="create-secret-form">
                    <div class="form-group">
                        <label>Mount Point:</label>
                        <select id="new-secret-mount" required>
                            <option value="secret">secret/ (Personal)</option>
                            <option value="team">team/ (Shared)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Path:</label>
                        <input type="text" id="new-secret-path" placeholder="e.g., myapp/config" required>
                    </div>
                    <div class="form-group">
                        <label>Data (JSON format):</label>
                        <textarea id="new-secret-data" rows="8" placeholder='{\n  "key1": "value1",\n  "key2": "value2"\n}' required></textarea>
                    </div>
                    <button type="submit" class="btn">T·∫°o Secret</button>
                </form>
            </div>
        </div>

        <div id="cert-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Issue Certificate</h2>
                    <button class="close-btn" onclick="closeModal('cert-modal')">&times;</button>
                </div>
                <form id="issue-cert-form">
                    <div class="form-group">
                        <label>Role:</label>
                        <select id="cert-role" required>
                            <option value="dev-role">dev-role (*.dev.example.com)</option>
                            <option value="prod-role">prod-role (*.example.com)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Common Name:</label>
                        <input type="text" id="cert-cn" placeholder="e.g., app.dev.example.com" required>
                    </div>
                    <div class="form-group">
                        <label>TTL (hours):</label>
                        <input type="number" id="cert-ttl" value="720" min="1" max="8760">
                    </div>
                    <button type="submit" class="btn">Issue Certificate</button>
                </form>
                <div id="cert-result" class="hidden mt-20"></div>
            </div>
        </div>

        <div id="upload-pem-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Upload PEM File</h2>
                    <button class="close-btn" onclick="closeModal('upload-pem-modal')">&times;</button>
                </div>
                <form id="upload-pem-form">
                    <div class="form-group">
                        <label>PEM File:</label>
                        <input type="file" id="pem-file" accept=".pem,.key,.crt,.cer,.p12,.pfx" required>
                        <small style="color: #666;">Accepts: .pem, .key, .crt, .cer, .p12, .pfx (max 10MB)</small>
                    </div>
                    <div class="form-group">
                        <label>Save Path:</label>
                        <input type="text" id="pem-path" placeholder="e.g., myserver" required>
                        <small style="color: #666;">Will be saved to: secret/pem-files/myserver</small>
                    </div>
                    <div class="form-group">
                        <label>Description:</label>
                        <input type="text" id="pem-description" placeholder="e.g., Production server SSL certificate">
                    </div>
                    <button type="submit" class="btn">Upload & Store</button>
                </form>
                <div id="upload-result" class="hidden mt-20"></div>
            </div>
        </div>

        <div id="generate-keypair-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Generate Key Pair</h2>
                    <button class="close-btn" onclick="closeModal('generate-keypair-modal')">&times;</button>
                </div>
                <form id="generate-keypair-form">
                    <div class="form-group">
                        <label>Key Type:</label>
                        <select id="keypair-type" required>
                            <option value="rsa">RSA</option>
                            <option value="ec">Elliptic Curve (EC)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Key Size:</label>
                        <select id="keypair-size" required>
                            <option value="2048">2048 bits</option>
                            <option value="4096">4096 bits</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Save Path:</label>
                        <input type="text" id="keypair-path" placeholder="e.g., my-keypair" required>
                        <small style="color: #666;">Will be saved to: secret/pem-files/my-keypair</small>
                    </div>
                    <div class="form-group">
                        <label>Description:</label>
                        <input type="text" id="keypair-description" placeholder="e.g., SSH key for production server">
                    </div>
                    <button type="submit" class="btn">Generate Key Pair</button>
                </form>
                <div id="keypair-result" class="hidden mt-20"></div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let currentTab = 'secrets';
        const backendBase = location.origin;

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            showMessage('ƒêang ƒëƒÉng nh·∫≠p...', 'success');
            
            try {
                const response = await fetch(`${backendBase}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();

                if (!response.ok || !data.ok) {
                    const reason = data?.vault?.errors ? data.vault.errors.join('; ') : 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i';
                    showMessage('L·ªói: ' + reason, 'error');
                    return;
                }

                currentUser = data;
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('dashboard-section').classList.remove('hidden');
                updateUserInfo();
                showTab('secrets');
            } catch (error) {
                showMessage('L·ªói: ' + error.message, 'error');
            }
        });

        async function logout() {
            try {
                await fetch(`${backendBase}/api/logout`, { method: 'POST' });
            } catch {}
            currentUser = null;
            document.getElementById('dashboard-section').classList.add('hidden');
            document.getElementById('login-section').classList.remove('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        function updateUserInfo() {
            document.getElementById('current-user').textContent = currentUser.username;
            document.getElementById('current-policies').textContent = currentUser.policies.join(', ');
            document.getElementById('session-time').textContent = `${Math.floor(currentUser.ttl / 3600)}h`;
        }

        function showTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            const content = document.getElementById('content-area');
            content.innerHTML = '<div class="loading">ƒêang t·∫£i...</div>';
            
            setTimeout(() => {
                switch(tab) {
                    case 'secrets': loadSecrets('secret'); break;
                    case 'team': loadSecrets('team'); break;
                    case 'pem': loadPEMFiles(); break;
                    case 'pki': loadPKI(); break;
                    case 'stats': loadStats(); break;
                    case 'audit': loadAudit(); break;
                }
            }, 100);
        }

        async function loadSecrets(mount) {
            const content = document.getElementById('content-area');
            
            try {
                const response = await fetch(`${backendBase}/api/list?mount=${mount}`);
                const data = await response.json();
                
                let html = `
                    <div style="background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h2 style="color: #333;">
                                ${mount === 'secret' ? 'üì¶ Personal Secrets' : 'ü§ù Team Shared Secrets'}
                            </h2>
                            <button class="btn btn-success btn-small" onclick="openCreateModal()">
                                + T·∫°o Secret M·ªõi
                            </button>
                        </div>
                    </div>
                    <div class="secrets-grid">
                `;
                
                if (!data?.data?.keys || data.data.keys.length === 0) {
                    html += '<p style="color: white; text-align: center; grid-column: 1/-1;">Kh√¥ng c√≥ secrets ho·∫∑c kh√¥ng c√≥ quy·ªÅn truy c·∫≠p</p>';
                } else {
                    for (const path of data.data.keys) {
                        if (path.endsWith('/')) {
                            const subData = await fetch(`${backendBase}/api/list?mount=${mount}&prefix=${path}`);
                            const subKeys = await subData.json();
                            if (subKeys?.data?.keys) {
                                for (const subPath of subKeys.data.keys) {
                                    if (!subPath.endsWith('/')) {
                                        html += await renderSecretCard(mount, path + subPath);
                                    }
                                }
                            }
                        } else {
                            html += await renderSecretCard(mount, path);
                        }
                    }
                }
                
                html += '</div>';
                content.innerHTML = html;
            } catch (error) {
                content.innerHTML = `<div class="error">L·ªói: ${error.message}</div>`;
            }
        }

        async function renderSecretCard(mount, path) {
            try {
                const response = await fetch(`${backendBase}/api/secret/${mount}/${path}`);
                if (!response.ok) return '';
                
                const data = await response.json();
                const secret = data?.data?.data;
                if (!secret) return '';
                
                let html = `
                    <div class="secret-card">
                        <h3>
                            <span>üîë ${path}</span>
                            <span class="mount-label">${mount}</span>
                        </h3>
                `;
                
                for (const [key, value] of Object.entries(secret)) {
                    const isSecret = ['password', 'secret', 'key', 'token', 'private'].some(k => 
                        key.toLowerCase().includes(k)
                    );
                    const inputId = `${mount}-${path}-${key}`.replace(/[\/\s]/g, '-');
                    
                    const isCert = typeof value === 'string' && 
                                   (value.includes('BEGIN CERTIFICATE') || 
                                    value.includes('BEGIN PRIVATE KEY') ||
                                    value.includes('BEGIN RSA PRIVATE KEY'));
                    
                    html += `
                        <div class="secret-item">
                            <label>${key}:</label>
                            <div class="secret-value">
                    `;
                    
                    if (isCert) {
                        html += `
                            <textarea id="${inputId}" readonly style="width: 100%; height: 100px; font-family: monospace; font-size: 0.8em;">${value}</textarea>
                        `;
                    } else {
                        html += `
                            <input type="${isSecret ? 'password' : 'text'}" 
                                   value="${value}" 
                                   id="${inputId}"
                                   readonly>
                        `;
                    }
                    
                    html += `
                                <button class="copy-btn" onclick="copySecret('${inputId}', this)">Copy</button>
                            </div>
                        </div>
                    `;
                }
                
                html += `
                        <div class="action-buttons">
                            <button class="btn btn-small delete-btn" onclick="deleteSecret('${mount}', '${path}')">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                `;
                
                return html;
            } catch (error) {
                return '';
            }
        }

        async function loadPEMFiles() {
            const content = document.getElementById('content-area');
            
            content.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px; margin-bottom: 20px;">
                    <h2 style="color: #333; margin-bottom: 20px;">üîí PEM Files Management</h2>
                    
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button class="btn btn-success btn-small" onclick="openModal('upload-pem-modal')">
                            üì§ Upload PEM File
                        </button>
                        <button class="btn btn-small" onclick="openModal('generate-keypair-modal')">
                            üîë Generate Key Pair
                        </button>
                    </div>
                    
                    <div class="warning">
                        <strong>üîí Secure Storage:</strong> PEM files are encrypted at rest (AES-256) and access is logged in audit trail.
                    </div>
                </div>
                
                <div id="pem-files-container">
                    <div class="loading">Loading PEM files...</div>
                </div>
            `;
            
            try {
                const response = await fetch(`${backendBase}/api/list?mount=secret&prefix=pem-files/`);
                const data = await response.json();
                
                let html = '<div class="secrets-grid">';
                
                if (!data?.data?.keys || data.data.keys.length === 0) {
                    html = '<p style="color: white; text-align: center; padding: 40px;">No PEM files stored yet. Upload one to get started!</p>';
                } else {
                    for (const path of data.data.keys) {
                        if (!path.endsWith('/')) {
                            html += await renderPEMCard('secret', 'pem-files/' + path);
                        }
                    }
                    html += '</div>';
                }
                
                document.getElementById('pem-files-container').innerHTML = html;
            } catch (error) {
                document.getElementById('pem-files-container').innerHTML = 
                    `<div class="error">Error loading PEM files: ${error.message}</div>`;
            }
        }

        async function renderPEMCard(mount, path) {
            try {
                const response = await fetch(`${backendBase}/api/secret/${mount}/${path}`);
                if (!response.ok) return '';
                
                const data = await response.json();
                const pem = data?.data?.data;
                if (!pem) return '';
                
                const displayName = path.replace('pem-files/', '');
                const typeIcon = pem.type === 'certificate' ? 'üìú' : 
                                pem.type && pem.type.includes('private') ? 'üîê' : 'üîë';
                
                return `
                    <div class="secret-card">
                        <h3>
                            <span>${typeIcon} ${displayName}</span>
                            <span class="mount-label">PEM</span>
                        </h3>
                        
                        <div class="secret-item">
                            <label>Type:</label>
                            <div style="padding: 8px; background: #f0f0f0; border-radius: 4px;">
                                ${pem.type || 'unknown'}
                            </div>
                        </div>
                        
                        <div class="secret-item">
                            <label>Filename:</label>
                            <div style="padding: 8px; background: #f0f0f0; border-radius: 4px;">
                                ${pem.filename || 'N/A'}
                            </div>
                        </div>
                        
                        ${pem.description ? `
                        <div class="secret-item">
                            <label>Description:</label>
                            <div style="padding: 8px; background: #f0f0f0; border-radius: 4px;">
                                ${pem.description}
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="secret-item">
                            <label>Fingerprint:</label>
                            <div style="padding: 8px; background: #f0f0f0; border-radius: 4px; font-family: monospace; font-size: 0.85em;">
                                ${pem.fingerprint || 'N/A'}
                            </div>
                        </div>
                        
                        <div class="secret-item">
                            <label>Size:</label>
                            <div style="padding: 8px; background: #f0f0f0; border-radius: 4px;">
                                ${pem.size ? (pem.size / 1024).toFixed(2) + ' KB' : 'N/A'}
                            </div>
                        </div>
                        
                        <div class="secret-item">
                            <label>Uploaded By:</label>
                            <div style="padding: 8px; background: #f0f0f0; border-radius: 4px;">
                                ${pem.uploaded_by || pem.generated_by || 'N/A'} 
                                <small>(${pem.uploaded_at || pem.generated_at ? new Date(pem.uploaded_at || pem.generated_at).toLocaleString('vi-VN') : 'N/A'})</small>
                            </div>
                        </div>
                        
                        <div class="secret-item">
                            <label>Content Preview:</label>
                            <textarea readonly style="width: 100%; height: 120px; font-family: monospace; font-size: 0.75em; padding: 8px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px;">${pem.content ? pem.content.substring(0, 300) + '...' : pem.private_key ? pem.private_key.substring(0, 300) + '...' : 'N/A'}</textarea>
                        </div>
                        
                        <div class="action-buttons">
                            <button class="btn btn-small" onclick="downloadPEM('${mount}', '${path}', '${pem.filename || displayName + '.pem'}')">
                                üì• Download
                            </button>
                            <button class="btn btn-small" onclick="viewPEMFull('${mount}', '${path}')">
                                üëÅÔ∏è View Full
                            </button>
                            <button class="btn btn-small delete-btn" onclick="deleteSecret('${mount}', '${path}')">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                `;
            } catch (error) {
                return '';
            }
        }

        async function downloadPEM(mount, path, filename) {
            try {
                const response = await fetch(`${backendBase}/api/download-pem/${mount}/${path}`);
                if (!response.ok) {
                    alert('Failed to download PEM file');
                    return;
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                alert('‚úÖ PEM file downloaded!');
            } catch (error) {
                alert('Error downloading file: ' + error.message);
            }
        }

        async function viewPEMFull(mount, path) {
            try {
                const response = await fetch(`${backendBase}/api/secret/${mount}/${path}`);
                const data = await response.json();
                const pem = data?.data?.data;
                
                if (!pem) {
                    alert('Failed to load PEM content');
                    return;
                }
                
                const content = pem.content || pem.private_key || pem.certificate || 'No content available';
                
                const modal = document.createElement('div');
                modal.className = 'modal show';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 800px;">
                        <div class="modal-header">
                            <h2>PEM File Content</h2>
                            <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                        </div>
                        <textarea readonly style="width: 100%; height: 500px; font-family: monospace; font-size: 0.85em; padding: 15px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px;">${content}</textarea>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-small" onclick="copyToClipboard(\`${content.replace(/`/g, '\\`').replace(/\$/g, '\\)}\`)">
                                üìã Copy to Clipboard
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                alert('Error viewing PEM: ' + error.message);
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('‚úÖ Copied to clipboard!');
            }).catch(err => {
                alert('Failed to copy: ' + err.message);
            });
        }

        document.getElementById('upload-pem-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fileInput = document.getElementById('pem-file');
            const path = document.getElementById('pem-path').value;
            const description = document.getElementById('pem-description').value;
            
            if (!fileInput.files[0]) {
                alert('Please select a file');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('secretPath', 'pem-files/' + path);
            formData.append('description', description);
            
            try {
                const response = await fetch(`${backendBase}/api/upload-pem`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    document.getElementById('upload-result').innerHTML = `
                        <div class="success">
                            ‚úÖ PEM file uploaded successfully!<br>
                            <strong>Type:</strong> ${result.type}<br>
                            <strong>Fingerprint:</strong> ${result.fingerprint}<br>
                            <strong>Path:</strong> secret/${result.path}
                        </div>
                    `;
                    document.getElementById('upload-result').classList.remove('hidden');
                    
                    document.getElementById('upload-pem-form').reset();
                    
                    setTimeout(() => {
                        closeModal('upload-pem-modal');
                        if (currentTab === 'pem') {
                            loadPEMFiles();
                        }
                    }, 2000);
                } else {
                    alert('‚ùå Upload failed: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        });

        document.getElementById('generate-keypair-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const keyType = document.getElementById('keypair-type').value;
            const keySize = document.getElementById('keypair-size').value;
            const path = document.getElementById('keypair-path').value;
            const description = document.getElementById('keypair-description').value;
            
            try {
                const response = await fetch(`${backendBase}/api/generate-keypair`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        keyType,
                        keySize,
                        secretPath: 'pem-files/' + path,
                        description
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    document.getElementById('keypair-result').innerHTML = `
                        <div class="success">‚úÖ Key pair generated successfully!</div>
                        
                        <div style="margin-top: 15px;">
                            <h4>Public Key:</h4>
                            <div class="cert-display">${result.publicKey}</div>
                            <button class="btn btn-small mt-20" onclick="copyToClipboard(\`${result.publicKey.replace(/`/g, '\\`').replace(/\$/g, '\\)}\`)">
                                üìã Copy Public Key
                            </button>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <h4>Private Key:</h4>
                            <div class="cert-display">${result.privateKey}</div>
                            <button class="btn btn-small mt-20" onclick="copyToClipboard(\`${result.privateKey.replace(/`/g, '\\`').replace(/\$/g, '\\)}\`)">
                                üìã Copy Private Key
                            </button>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <p><strong>Fingerprint:</strong> ${result.fingerprint}</p>
                            <p style="color: #856404; background: #fff3cd; padding: 10px; border-radius: 4px;">
                                ‚ö†Ô∏è <strong>Important:</strong> Private key is shown only once. Download or copy it now!
                            </p>
                        </div>
                    `;
                    document.getElementById('keypair-result').classList.remove('hidden');
                    
                    document.getElementById('generate-keypair-form').reset();
                } else {
                    alert('‚ùå Generation failed: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        });

        async function loadPKI() {
            const content = document.getElementById('content-area');
            content.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px;">
                    <h2 style="color: #333; margin-bottom: 20px;">üîê PKI Certificate Management</h2>
                    
                    <div class="warning">
                        <strong>‚ö†Ô∏è Certificate Authority:</strong> Issue SSL/TLS certificates on-demand
                    </div>
                    
                    <div style="margin: 30px 0;">
                        <h3 style="color: #555; margin-bottom: 15px;">Available Roles:</h3>
                        <div class="secrets-grid">
                            <div class="secret-card">
                                <h3>dev-role</h3>
                                <p style="color: #666; margin: 10px 0;">
                                    <strong>Domains:</strong> *.dev.example.com<br>
                                    <strong>Max TTL:</strong> 720 hours (30 days)
                                </p>
                                <button class="btn btn-small" onclick="openCertModal('dev-role')">
                                    Issue Certificate
                                </button>
                            </div>
                            <div class="secret-card">
                                <h3>prod-role</h3>
                                <p style="color: #666; margin: 10px 0;">
                                    <strong>Domains:</strong> *.example.com<br>
                                    <strong>Max TTL:</strong> 8760 hours (1 year)
                                </p>
                                <button class="btn btn-small" onclick="openCertModal('prod-role')">
                                    Issue Certificate
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <h3 style="color: #555; margin-bottom: 15px;">Issued Certificates:</h3>
                        <div id="issued-certs">Loading...</div>
                    </div>
                </div>
            `;
            
            // Load certificates from secrets
            loadIssuedCerts();
        }

        async function loadIssuedCerts() {
            try {
                const response = await fetch(`${backendBase}/api/list?mount=secret&prefix=certificates/`);
                const data = await response.json();
                const certsDiv = document.getElementById('issued-certs');
                
                if (!data?.data?.keys || data.data.keys.length === 0) {
                    certsDiv.innerHTML = '<p style="color: #999;">Ch∆∞a c√≥ certificate n√†o ƒë∆∞·ª£c issue</p>';
                    return;
                }
                
                let html = '<div class="secrets-grid">';
                for (const path of data.data.keys) {
                    if (!path.endsWith('/')) {
                        html += await renderSecretCard('secret', 'certificates/' + path);
                    }
                }
                html += '</div>';
                certsDiv.innerHTML = html;
            } catch (error) {
                document.getElementById('issued-certs').innerHTML = 
                    `<p style="color: #999;">Kh√¥ng th·ªÉ load certificates</p>`;
            }
        }

        async function loadStats() {
            const content = document.getElementById('content-area');
            
            try {
                const response = await fetch(`${backendBase}/api/stats`);
                const data = await response.json();
                
                content.innerHTML = `
                    <div style="background: white; padding: 30px; border-radius: 15px;">
                        <h2 style="color: #333; margin-bottom: 30px;">üìä System Statistics</h2>
                        
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value">${data.secrets?.secret || 0}</div>
                                <div class="stat-label">Personal Secrets</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${data.secrets?.team || 0}</div>
                                <div class="stat-label">Team Secrets</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${data.policies?.length || 0}</div>
                                <div class="stat-label">Active Policies</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">‚úì</div>
                                <div class="stat-label">Audit Enabled</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                            <h3 style="color: #555; margin-bottom: 15px;">Session Information</h3>
                            <p><strong>Username:</strong> ${data.username}</p>
                            <p><strong>Policies:</strong> ${data.policies?.join(', ')}</p>
                            <p><strong>Login Time:</strong> ${new Date(data.loginTime).toLocaleString('vi-VN')}</p>
                        </div>
                        
                        <div style="margin-top: 30px; padding: 20px; background: #e8f5e9; border-radius: 10px;">
                            <h3 style="color: #2e7d32; margin-bottom: 15px;">‚úÖ Security Features Active</h3>
                            <ul style="list-style: none; padding: 0;">
                                <li style="padding: 8px 0;">‚úì AES-256 Encryption</li>
                                <li style="padding: 8px 0;">‚úì Policy-based Access Control</li>
                                <li style="padding: 8px 0;">‚úì Audit Logging Enabled</li>
                                <li style="padding: 8px 0;">‚úì Token TTL: ${Math.floor((data.ttl || 0) / 3600)}h</li>
                                <li style="padding: 8px 0;">‚úì Auto Backup Every Hour</li>
                                <li style="padding: 8px 0;">‚úì PEM Files Management</li>
                            </ul>
                        </div>
                    </div>
                `;
            } catch (error) {
                content.innerHTML = `<div class="error">L·ªói: ${error.message}</div>`;
            }
        }

        async function loadAudit() {
            const content = document.getElementById('content-area');
            
            try {
                const response = await fetch(`${backendBase}/api/audit`);
                const data = await response.json();
                
                if (!response.ok) {
                    content.innerHTML = `
                        <div class="warning">
                            <strong>‚ö†Ô∏è Kh√¥ng c√≥ quy·ªÅn xem Audit Log</strong><br>
                            Ch·ªâ admin m·ªõi c√≥ quy·ªÅn xem audit logs.
                        </div>
                    `;
                    return;
                }
                
                const auditDevices = data?.data || data;
                const deviceList = Object.entries(auditDevices).map(([name, info]) => 
                    `<li><strong>${name}</strong>: ${info.type} - ${info.path || 'N/A'}</li>`
                ).join('');
                
                content.innerHTML = `
                    <div style="background: white; padding: 30px; border-radius: 15px;">
                        <h2 style="color: #333; margin-bottom: 20px;">üìù Audit Log Configuration</h2>
                        
                        <div class="success">
                            <strong>‚úÖ Audit Logging Enabled</strong><br>
                            T·∫•t c·∫£ truy c·∫≠p v√†o Vault ƒë·ªÅu ƒë∆∞·ª£c ghi log.
                        </div>
                        
                        <div style="margin-top: 30px;">
                            <h3 style="color: #555; margin-bottom: 15px;">Active Audit Devices:</h3>
                            <ul style="padding-left: 20px;">
                                ${deviceList}
                            </ul>
                        </div>
                        
                        <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                            <h3 style="color: #555; margin-bottom: 15px;">Audit Log Information:</h3>
                            <p><strong>Location:</strong> /vault/logs/audit.log (trong container)</p>
                            <p><strong>Format:</strong> JSON</p>
                            <p><strong>Logged Information:</strong></p>
                            <ul style="margin-top: 10px; padding-left: 20px;">
                                <li>User authentication (login/logout)</li>
                                <li>Secret read/write/delete operations</li>
                                <li>PEM file uploads/downloads</li>
                                <li>Policy changes</li>
                                <li>Timestamp v√† IP address</li>
                                <li>Request/Response details</li>
                            </ul>
                        </div>
                        
                        <div style="margin-top: 30px; padding: 15px; background: #fff3cd; border-radius: 10px;">
                            <strong>üí° Xem Audit Log:</strong><br>
                            <code style="background: #f8f9fa; padding: 5px 10px; border-radius: 4px; display: inline-block; margin-top: 10px;">
                                docker exec vault-demo cat /vault/logs/audit.log | tail -n 50
                            </code>
                        </div>
                    </div>
                `;
            } catch (error) {
                content.innerHTML = `<div class="error">L·ªói: ${error.message}</div>`;
            }
        }

        function openCreateModal() {
            document.getElementById('create-modal').classList.add('show');
        }

        function openCertModal(role) {
            document.getElementById('cert-role').value = role;
            document.getElementById('cert-result').classList.add('hidden');
            document.getElementById('cert-modal').classList.add('show');
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        document.getElementById('create-secret-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const mount = document.getElementById('new-secret-mount').value;
            const path = document.getElementById('new-secret-path').value;
            const dataText = document.getElementById('new-secret-data').value;
            
            try {
                const data = JSON.parse(dataText);
                const response = await fetch(`${backendBase}/api/secret/${mount}/${path}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    alert('‚úÖ Secret ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!');
                    closeModal('create-modal');
                    document.getElementById('create-secret-form').reset();
                    showTab(mount === 'team' ? 'team' : 'secrets');
                } else {
                    const error = await response.json();
                    alert('‚ùå L·ªói: ' + (error.errors ? error.errors.join(', ') : 'Kh√¥ng th·ªÉ t·∫°o secret'));
                }
            } catch (error) {
                alert('‚ùå L·ªói: ' + error.message);
            }
        });

        document.getElementById('issue-cert-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const role = document.getElementById('cert-role').value;
            const cn = document.getElementById('cert-cn').value;
            const ttl = document.getElementById('cert-ttl').value + 'h';
            
            try {
                const response = await fetch(`${backendBase}/api/pki/issue`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role, common_name: cn, ttl })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    const cert = data.data;
                    document.getElementById('cert-result').innerHTML = `
                        <div class="success">‚úÖ Certificate issued successfully!</div>
                        <div style="margin-top: 15px;">
                            <h4>Certificate:</h4>
                            <div class="cert-display">${cert.certificate}</div>
                        </div>
                        <div style="margin-top: 15px;">
                            <h4>Private Key:</h4>
                            <div class="cert-display">${cert.private_key}</div>
                        </div>
                        <div style="margin-top: 15px;">
                            <p><strong>Serial:</strong> ${cert.serial_number}</p>
                            <p><strong>Expires:</strong> ${new Date(Date.now() + cert.ttl * 1000).toLocaleString('vi-VN')}</p>
                        </div>
                    `;
                    document.getElementById('cert-result').classList.remove('hidden');
                    
                    await fetch(`${backendBase}/api/secret/secret/certificates/${cn}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            certificate: cert.certificate,
                            private_key: cert.private_key,
                            domain: cn,
                            serial: cert.serial_number,
                            issued_at: new Date().toISOString()
                        })
                    });
                } else {
                    alert('‚ùå L·ªói: ' + (data.errors ? data.errors.join(', ') : 'Kh√¥ng th·ªÉ issue certificate'));
                }
            } catch (error) {
                alert('‚ùå L·ªói: ' + error.message);
            }
        });

        async function deleteSecret(mount, path) {
            if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a secret: ${mount}/${path}?`)) return;
            
            try {
                const response = await fetch(`${backendBase}/api/secret/${mount}/${path}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('‚úÖ Secret ƒë√£ ƒë∆∞·ª£c x√≥a');
                    if (currentTab === 'pem' && path.startsWith('pem-files/')) {
                        loadPEMFiles();
                    } else {
                        showTab(mount === 'team' ? 'team' : 'secrets');
                    }
                } else {
                    alert('‚ùå Kh√¥ng th·ªÉ x√≥a secret');
                }
            } catch (error) {
                alert('‚ùå L·ªói: ' + error.message);
            }
        }

        // Copy Secret
        function copySecret(inputId, button) {
            const input = document.getElementById(inputId);
            const originalType = input.type;
            
            if (input.tagName === 'TEXTAREA') {
                input.select();
            } else {
                input.type = 'text';
                input.select();
            }
            
            document.execCommand('copy');
            
            if (originalType) input.type = originalType;
            
            button.textContent = '‚úì Copied!';
            button.classList.add('copied');
            setTimeout(() => {
                button.textContent = 'Copy';
                button.classList.remove('copied');
            }, 2000);
        }

        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.className = type;
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';
            if (type !== 'success') {
                setTimeout(() => messageDiv.style.display = 'none', 5000);
            }
        }
    </script>
</body>
</html>